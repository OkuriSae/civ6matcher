# Civ6 Matcher Discord Bot

`discord.py` を利用して Civilization VI のマッチングを支援する Discord Bot です。募集メッセージの作成・参加者管理・チーム分けを行う `/bo` コマンドと、動作確認用の `/ping` コマンドを提供しています。

## 必要環境

- Python 3.11 以上
- Discord Bot アカウントとトークン
- （任意）特定ギルドにのみコマンドを同期する場合はギルド ID

## セットアップ手順

1. 依存パッケージをインストールします。
   ```bash
   python -m venv .venv
   # macOS / Linux
   source .venv/bin/activate
   # Windows (PowerShell)
   .\.venv\Scripts\Activate.ps1
   pip install -r requirements.txt
   ```

2. `.env` ファイルを作成し、以下の内容を設定します。

   ```text
   DISCORD_BOT_TOKEN=ここにボットトークン
   # 任意設定
   DISCORD_COMMAND_PREFIX=!
   DISCORD_GUILD_ID=123456789012345678
   ```

   - `DISCORD_BOT_TOKEN` は必須です。
   - `DISCORD_COMMAND_PREFIX` を変更するとハイブリッドコマンドのプレフィックスが変わります。
   - `DISCORD_GUILD_ID` を設定すると、そのギルドにのみスラッシュコマンドを同期します（未設定の場合はグローバル同期）。

## 実行方法

```bash
python -m bot.main
```

起動後、Bot が Discord に接続すると以下のコマンドが利用できます。

## コマンド

### `/bo`

募集メッセージの作成・管理を行うコマンドです。

#### 基本機能

- `/bo [募集タイトル]`
  - チャンネル名に応じて対応する募集ロールをメンションし、埋め込みメッセージを生成します。
  - コマンド実行ユーザーは自動的に参加者に追加されます。
  - 参加者は👋リアクションで参加・離脱でき、最大 12 名までの参加者一覧と補欠リストが自動更新されます。
  - 参加者リストには参加順に番号が付与されます（例: `1. @user1`, `2. @user2`）。

#### リアクション機能

- **👋（参加）**: 参加者リストに追加されます。リアクションを外すとリストから削除されます。
- **⚔️（チーム分け）**: 参加者のロールに応じた重み付けをもとにバランスの取れたチーム分けを行います。
  - 参加者が奇数の場合はチーム分けは実行されません。
  - チーム分け後、人数が異なる場合は自動的に調整されます。
  - チーム欄は初めて⚔️が押されるまで非表示です。
- **➕（ダミー追加）**: ダミー参加者を追加します（`ダミー1`, `ダミー2`...）。
- **📢（参加者通知）**: 現在の参加者（補欠を除く）をまとめてメンションします。
- **♻️（募集通知）**: チャンネルに対応したロールに、あと何人必要かを通知します。
  - 参加者数に応じて必要な人数の範囲を表示します（例: `@1-3`）。
  - 12名以上の場合、メッセージは送信されません。
- **🇵/🇺/7️⃣/🇱（マップ投票）**: マップ投票用のリアクション（Bot としては何も処理しません）。

#### 管理機能

- `/bo remove_user:<@ユーザーID>`
  - 指定したユーザーを参加者リストから削除します。
  - ユーザーメンション形式（`<@123456789>`）をコピー&ペーストして指定できます。
  - チャンネル内の最新の募集メッセージから該当ユーザーを削除します。

- `/bo close_game:<メッセージID>`
  - 指定した募集メッセージを終了します。
  - 埋め込みメッセージの色が赤に変更され、タイトルの頭に `【解散】` が追加されます。
  - リアクションによるイベントは発火しなくなります。
  - 参加者全員にメンションします。

#### チーム分けの仕様

- 参加者のロールに応じて重み付けが行われます：
  - 特定ロール（ID: `1280186048395218995`）: 重み 4
  - 特定ロール（ID: `1280186025762750583`）: 重み 3
  - 特定ロール（ID: `1280185996184522927`）: 重み 2
  - その他: 重み 1
- 同じ重みの参加者はランダムに振り分けられます。
- 補欠（13人目以降）はチーム分けの対象外です。

### `/ping`

Bot の応答時間をミリ秒単位で返します。

## 補足

- `.env` の読み込みには `python-dotenv` を利用しています。環境変数を直接設定して実行することも可能です。
- チャンネル名とロール ID の対応、重み付け対象ロール ID は `bot/commands/bo.py` 内の `ROLE_MAPPING` と `_with_weights` メソッドで定義しています。サーバー構成に合わせて編集してください。
- Server Members Intent を有効化する必要があります。Discord Developer Portal で Bot の設定から有効化してください。
- リポジトリには `dockerfile` と `docker-compose.yml` が含まれていますが、現状は開発用のサンプルです。利用する場合は必要に応じて `volumes` や依存パッケージの定義を調整してください。

## ディレクトリ構成

```
civ6matcher/
├── bot/
│   ├── __init__.py
│   ├── config.py
│   ├── main.py
│   └── commands/
│       ├── __init__.py
│       ├── bo.py
│       └── ping.py
├── docker-compose.yml
├── dockerfile
├── README.md
└── requirements.txt
```

## ホスティングTIPS

以下を参考にしてください

[Dockerを用いたDiscordBOTの環境構築をGCE上でやってみた](https://zenn.dev/mixi/articles/97a39d8d6d9890)


